<html>
<head>
    <title>Authentication with NFT</title>
    <meta charset="utf-8" />

    <style type="text/css">
        .explorer {
            padding-left: 5pt;
            text-decoration: none;
        }

        .verified {
            background-color: lightgreen;
        }
    </style>

    <!--jQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!--@solana/web3.js-->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <script>
        const METADATA_PROGRAM_ID = new solanaWeb3.PublicKey('metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s');
        const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');

        // è‡ªä½œã®èªè¨¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
        const AUTH_WITH_NFT_PROGRAM_ID = new solanaWeb3.PublicKey('7z8YAaW58dXCb4Fo6AyAA5BEHGyBsEN3U6W2G9yVRXKH');


        // Clientå–å¾— (Devnetã®ã¿ã—ã‹é¸æŠã§ããªã„GUIã«ã—ã¦ã„ã‚‹)
        function get_client() {
            let cluster = $("#cluster").val();
            return new solanaWeb3.Connection(solanaWeb3.clusterApiUrl(cluster), 'confirmed');
        }

        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šã—ã¦ã‹ã‚‰ f ã‚’å®Ÿè¡Œ (æ¥ç¶šæ¸ˆã¿ã®å ´åˆã¯ãã®ã¾ã¾ f å®Ÿè¡Œã•ã‚Œã‚‹)
        async function connect_wallet_then(f) {
            clear_error();
            window.solana.connect()
            .then(async function ({publicKey}) {
                set_wallet_address(window.solana.publicKey);
                await f();
            })
            .catch(function (e) {
                set_error(`code: ${e.code} message: ${e.message}`);
                console.log(e);
            });
        }

        // ãƒ†ã‚¹ãƒˆç”¨ã«éƒ½åˆè‰¯ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿”ã›ã‚‹ä½™åœ°ã‚’ä½œã‚‹
        function get_wallet_pubkey() {
            return window.solana.publicKey;
        }

        // ãƒŸãƒ³ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å°å‡º
        async function get_metadata_account_pubkey(mint_account_pubkey) {
            // å‚ç…§: https://github.com/metaplex-foundation/python-api/blob/main/metaplex/metadata.py
            let seeds = [
                new TextEncoder().encode("metadata"),
                METADATA_PROGRAM_ID.toBytes(),
                mint_account_pubkey.toBytes(),
            ];
            let [pubkey, bump] = await solanaWeb3.PublicKey.findProgramAddress(seeds, METADATA_PROGRAM_ID);
            return pubkey;
        }

        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿å–å¾—
        function parse_metadata_account(data_uint8array) {
            if ( data_uint8array.length < 1+32+32 ) return null;
 
            // update_authority, mint ã®ã¿åˆ‡ã‚Šå‡ºã—
            let update_authority = new solanaWeb3.PublicKey(data_uint8array.slice(1, 1+32));
            let mint =  new solanaWeb3.PublicKey(data_uint8array.slice(1+32, 1+32+32));
            return {
                update_authority: update_authority,
                mint: mint,
            };
        }

        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆå†…ã®æ®‹é«˜è¡¨ç¤ºæ›´æ–°
        async function update_balance() {
            try {
                let wallet_pubkey = get_wallet_pubkey();
                let clnt = get_client();

                clear_error();
                clear_balance();
                let parsed_token_accounts = await clnt.getParsedTokenAccountsByOwner(
                    wallet_pubkey,
                    { programId: TOKEN_PROGRAM_ID });
                set_balance(parsed_token_accounts);
            } catch (e) {
                set_error(e);
            }
        }

        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆå†…ã‹ã‚‰ update_authority ã«æ‰€å±ã™ã‚‹NFTã‚’æ¢ã™
        async function find_from_wallet() {
            try {
                let update_authority_pubkey = new solanaWeb3.PublicKey($("#input_update_authority").val().trim());
                let wallet_pubkey = get_wallet_pubkey();
                let clnt = get_client();

                clear_error();

                // 1. ãƒˆãƒ¼ã‚¯ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—ã—ã€æ®‹é«˜1, decimals=0 ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å€™è£œã«ã™ã‚‹
                let parsed_token_accounts = await clnt.getParsedTokenAccountsByOwner(
                    wallet_pubkey,
                    { programId: TOKEN_PROGRAM_ID });

                let candidates = [];
                let value = parsed_token_accounts.value;
                for (let i=0; i<value.length; i++) {
                    // value.N.account.data.parsed.info.{mint, tokenAmount.{uiAmountString, decimals}}
                    let token_account = value[i].account.data.parsed.info;
                    let amount = token_account.tokenAmount;

                    if ( amount.uiAmountString === "1" && amount.decimals === 0 ) {
                        let mint_account_pubkey = new solanaWeb3.PublicKey(token_account.mint);
                        let metadata_account_pubkey = await get_metadata_account_pubkey(mint_account_pubkey);
                        candidates.push({
                            token: value[i].pubkey,
                            mint: mint_account_pubkey,
                            metadata: metadata_account_pubkey
                        });
                    }
                }
                console.log(candidates);

                // 2. å€™è£œã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä¸€æ‹¬å–å¾—ã—ã€update_authorityã‚’æŒã¤ã‚‚ã®ã‚’æ¢ã™
                let metadata_account_pubkeys = [];
                for (let i=0; i<candidates.length; i++) {
                    metadata_account_pubkeys.push(candidates[i].metadata);
                }
                let metadata_accounts = await clnt.getMultipleAccountsInfo(metadata_account_pubkeys);
                console.log(metadata_accounts);

                for (let i=0; i<candidates.length; i++) {
                    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè‡ªä½“ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦–
                    if ( metadata_accounts[i] === null ) continue;
                    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚ªãƒ¼ãƒŠãƒ¼ãŒMETAPLEXã§ãªã„å ´åˆã¯ç„¡è¦–
                    if ( metadata_accounts[i].owner.toBase58() !== METADATA_PROGRAM_ID.toBase58() ) continue;
                    // ãƒ‘ãƒ¼ã‚¹ãŒå¤±æ•—ã™ã‚‹å ´åˆã¯ç„¡è¦–
                    let metadata = parse_metadata_account(metadata_accounts[i].data);
                    if ( metadata === null ) continue;
                    // ç›®çš„ã® update_authority ã§ãªã„å ´åˆã¯ç„¡è¦–
                    if ( metadata.update_authority.toBase58() !== update_authority_pubkey.toBase58() ) continue;
                    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å†…ã®ãƒŸãƒ³ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæƒ³å®šã¨ç•°ãªã‚‹å ´åˆã¯ç„¡è¦–
                    if ( metadata.mint.toBase58() !== candidates[i].mint.toBase58() ) continue;

                    // æ­£ã—ããƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã€ãƒŸãƒ³ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚å•é¡Œãªã„ã®ã§æ¡ç”¨ã™ã‚‹ (æœ€åˆã«è¦‹ã¤ã‘ãŸ1ã¤ã§ã‚ˆã„)
                    set_account(candidates[i].token, candidates[i].metadata);
                    return;
                }

                // è¦‹ã¤ã‹ã‚‰ãš...
                set_error("NOT FOUND!")
            } catch (e) {
                set_error(e);
            }
        }

        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        async function send_transaction() {
            try {
                let update_authority_pubkey = new solanaWeb3.PublicKey($("#input_update_authority").val().trim());
                let token_account_pubkey = new solanaWeb3.PublicKey($("#input_token").val().trim());
                let metadata_account_pubkey = new solanaWeb3.PublicKey($("#input_metadata").val().trim());
                let wallet_pubkey = get_wallet_pubkey();
                let clnt = get_client();

                clear_error();
                clear_tx();

                let instruction = new solanaWeb3.TransactionInstruction({
                    programId: AUTH_WITH_NFT_PROGRAM_ID,
                    keys: [
                        // 4ã¤ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¸¡ã™
                        { pubkey: wallet_pubkey, isWritable: false, isSigner: true },
                        { pubkey: update_authority_pubkey, isWritable: false, isSigner: false },
                        { pubkey: token_account_pubkey, isWritable: false, isSigner: false },
                        { pubkey: metadata_account_pubkey, isWritable: false, isSigner: false },
                    ],
                    data: '',
                });
                console.log(AUTH_WITH_NFT_PROGRAM_ID.toBase58());

                let tx = new solanaWeb3.Transaction();
                tx.recentBlockhash = (await clnt.getRecentBlockhash()).blockhash;
                tx.feePayer = wallet_pubkey;
                tx.add(instruction);
                console.log(tx);
                
                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                let signed = await window.solana.signTransaction(tx);
                console.log("signed", signed);
                let signature = await clnt.sendRawTransaction(signed.serialize());
                // signAndSendTransaction ã¯ã†ã¾ãã„ã‹ãªã„ã®ã§ signTransaction + sendRawTransaction 
                // onst { signature } = await window.solana.signAndSendTransaction(tx);

                set_tx("confirm...", signature, []);
                await clnt.confirmTransaction(signature);

                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚°å–å¾—
                let res = await clnt.getParsedConfirmedTransaction(signature);
                console.log(res);
                let logs = res.meta.logMessages;
                set_tx("confirmed", signature, logs);
            } catch (e) {
                set_error(e);
            }
        }

        // ä»¥é™ã¯è¡¨ç¤ºåˆ¶å¾¡ç”¨
        function set_wallet_address(pubkey) {
            $("#input_wallet").val(pubkey.toBase58());
        }

        function clear_tx() {
            $("#tx").html("");
        }

        function set_tx(state, signature, logs) {
            let explorer_url = "https://explorer.solana.com/tx/"
                             + signature
                             + "?cluster=devnet";

            let html = state + " " + signature
                     + ` <a class="explorer" href="${explorer_url}" target="_blank">ğŸ”</a>`

            if ( logs.length > 0 ) {
                html = html + "<ol>";
                for (let i=0; i<logs.length; i++) {
                    let verified = logs[i].match(/VERIFIED/) ? "class='verified'" : "";
                    html = html + `<li ${verified}>${logs[i]}</li>`;
                }
                html = html + "</ol>";
            }

            $("#tx").html(html);
        }

        function clear_error() {
            $("#error").text("");
        }

        function set_error(e) {
            $("#error").text("Error: " + e);
        }

        function set_account(token, metadata) {
            console.log(token, metadata);
            $("#input_token").val(token.toBase58());
            $("#input_metadata").val(metadata.toBase58());
        }

        function clear_balance() {
            $("#balance").find("tr").remove();
        }

        function set_balance(parsed_token_accounts) {
            // value.N.account.data.parsed.info.{mint, tokenAmount.uiAmountString}
            console.log(parsed_token_accounts);

            let value = parsed_token_accounts.value;
            for (let i=0; i<value.length; i++) {
                let token_account = value[i].account.data.parsed.info;
                console.log(token_account.mint, token_account.tokenAmount.uiAmountString);

                let mint = token_account.mint;
                let ui_amount = token_account.tokenAmount.uiAmountString;
                let html = `<tr><td>${token_account.mint}</td><td align="right">${ui_amount}</td></tr>`;
                $("#balance").append(html);
            }
        }
    </script>
</head>
<body>

<h1>ç‰¹å®šã®ã‚·ãƒªãƒ¼ã‚ºã®NFTã‚’æ‰€æœ‰ã—ã¦ã„ã‚‹ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã ã¨ä¸»å¼µã™ã‚‹</h1>
<p style="color: orange; font-weight: bold;">
    âš ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚Devnetã§ã™ãŒæ³¨æ„ãã ã•ã„ã€‚(çœåŠ›åŒ–ã®ãŸã‚Phantomå‰æã§ã™)
</p>

<p id="error" style="color: red;"></p>

<p>
    ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯:
    <select id="cluster">
        <option selected>devnet</option>
    </select>
</p>
<p>
    ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«æ¸¡ã™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ1: ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ (ç½²åè€…ã«ãªã‚Šã¾ã™)<br />
    <input type="text" size="60" id="input_wallet" disabled />
</p>
<p>
    ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«æ¸¡ã™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ2: æ‰€æœ‰ã—ã¦ã„ã‚‹ã¨ä¸»å¼µã™ã‚‹NFTã® update authority<br />
    <input type="text" size="60" id="input_update_authority" value="6EsaiJRWuNmHktqGemAaKEoFUd2kA864bcFgiysEEhMi" />
</p>
<p>
    ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«æ¸¡ã™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ3: ãƒˆãƒ¼ã‚¯ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ<br />
    <input type="text" size="60" id="input_token" />
</p>
<p>
    ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«æ¸¡ã™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ4: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ<br />
    <input type="text" size="60" id="input_metadata" />
</p>
<p>
    <button onclick="connect_wallet_then(find_from_wallet)">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆå†…ã‹ã‚‰æ¢ã—ã¦è‡ªå‹•å…¥åŠ›</button>
</p>
<p>
    <button onclick="connect_wallet_then(send_transaction)">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«NFTã‚’æ‰€æœ‰ã—ã¦ã„ã‚‹ã¨ä¸»å¼µã™ã‚‹</button>
</p>
<p>
    ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒä¸»å¼µã‚’èªã‚ã‚‹ã¨ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒæˆåŠŸã—ã¾ã™ã€‚
    [<a href="https://github.com/everlastingsong/solsandbox/tree/main/auth_with_nft">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚½ãƒ¼ã‚¹</a>]
</p>

<p id="tx"></p>

<hr>

<h1>ã‚¦ã‚©ãƒ¬ãƒƒãƒˆå†…ã®æ®‹é«˜</h1>
<p>
    <button onclick="connect_wallet_then(update_balance)">è¡¨ç¤ºæ›´æ–°</button>
</p>

<table border="1">
    <thead>
        <tr><th>ãƒŸãƒ³ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</th><th>æ®‹é«˜</th></tr>
    </thead>
    <tbody id="balance">
    </tbody>
</table>
</body>
</html>
