<html>
<head>
    <title>Solana Account Finder</title>
    <meta charset="utf-8" />

    <style type="text/css">
        #nfts a {
            padding-left: 5pt;
            text-decoration: none;
        }
    </style>

    <!--jQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!--@solana/web3.js-->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <script>
        const METADATA_PROGRAM_ID = new solanaWeb3.PublicKey('metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s');

        // Clientå–å¾— (ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡ã‚Šæ›¿ãˆ)
        function get_client() {
            let cluster = $("#cluster").val();
            return new solanaWeb3.Connection(solanaWeb3.clusterApiUrl(cluster), 'confirmed');
        }

        // ç‰¹å®šã® update_authority ã‚’æŒã¤ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
        async function get_metadata_accounts(clnt, update_authority_pubkey) {
            update_authority_filter = { 
                memcmp: {
                    offset: 1,
                    bytes: update_authority_pubkey.toBase58() }}; // Base58, max 128 bytes

            let config = {
                dataSlice: { // mint ã‚’åˆ‡ã‚ŠæŠœã
                    offset: 1+32,
                    length: 32 },
                filters: [
                    update_authority_filter
                ]};

            res = await clnt.getProgramAccounts(METADATA_PROGRAM_ID, config);
            return res;
        }

        async function find_nft_series() {
            let input_update_authority_pubkey = new solanaWeb3.PublicKey($("#input_update_authority").val().trim());

            try {
                let clnt = get_client();

                set_wait();
                let metadata_accounts = await get_metadata_accounts(clnt, input_update_authority_pubkey);
                set_list(metadata_accounts);
            } catch ( e ) {
                set_error(e);
            }
        }

        // ä»¥é™ã¯è¡¨ç¤ºæ“ä½œç”¨
        function set_wait() {
            $("#msg").text("wait...");
            $("#nfts").html("");
        }

        function set_error(e) {
            $("#msg").text("");
            $('p[id="error"]').text("Error: " + e);
        }

        function set_list(metadata_accounts) {
            $("#msg").text("NFT count: " + metadata_accounts.length);
            console.log(metadata_accounts);

            let is_devnet = $("#cluster").val() === "devnet";
            let html = "";
            for (let i=0; i<20; i++) {
                let metadata_account_pubkey = metadata_accounts[i].pubkey;
                let data = metadata_accounts[i].account.data;
                let mint_account_pubkey = new solanaWeb3.PublicKey(data);

                let explorer_url = "https://explorer.solana.com/address/"
                                 + mint_account_pubkey.toBase58()
                                 + (is_devnet ? "?cluster=devnet" : "");

                html = html
                     + "<li>"
                     + " mint: " + mint_account_pubkey.toBase58()
                     + ` <a href="${explorer_url}" target="_blank">ğŸ”</a>` + "<br>"
                     + " metadata: " + metadata_account_pubkey.toBase58() + ")</li>";
            }
            $("#nfts").html(html);
        }
    </script>
</head>
<body>

<h1>findProgramAccounts ã®ä½¿ã„æ–¹</h1>
<p><a href="https://solanacookbook.com/guides/get-program-accounts.html">Solana Cookbook</a> ãŒã‚ã‹ã‚Šã‚„ã™ã„ã€‚</p>

<p>
ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’
<ol>
    <li>owner ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ID</li>
    <li>data ã®ã‚µã‚¤ã‚º</li>
    <li>data ã®ç‰¹å®šä½ç½®ã«ç‰¹å®šãƒã‚¤ãƒˆé…åˆ—ãŒå­˜åœ¨ã™ã‚‹ã“ã¨</li>
</ol>
ã®3ã¤ã®æ¡ä»¶ã‚’æŒ‡å®šã—ã¦å–å¾—ã§ãã‚‹ã€‚
</p>
<p>
    å–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚‚ data ã®ç‰¹å®šã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‹ã‚‰ç‰¹å®šãƒã‚¤ãƒˆæ•°ã ã‘åˆ‡ã‚Šå‡ºã›ã‚‹ã€‚
</p>
<p>
NFTã®ç‰¹å®šã®ã‚·ãƒªãƒ¼ã‚ºã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¢ã™ã«ã¯ã€
<ol>
    <li>ãƒ—ãƒ­ã‚°ãƒ©ãƒ ID ãŒ METADATA_PROGRAM_ID(metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s) ã§ã‚ã‚‹ã“ã¨</li>
    <li>data ã®ã‚µã‚¤ã‚ºæŒ‡å®šã¯ãªã—</li>
    <li>data ã® 4ãƒã‚¤ãƒˆç›®ã‹ã‚‰ã®32ãƒã‚¤ãƒˆç¶šããŒ update_authority ã® pubkey ã§ã‚ã‚‹ã“ã¨</li>
</ol>
ã§æ¢ã›ã°ã‚ˆã„ã€‚
</p>

<hr>

<h1>ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ</h1>
<p>
    ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯:
    <select id="cluster">
        <option selected>devnet</option>
        <option>mainnet-beta</option>
    </select>
</p>
<p>
    æ¢ã™NFTã® update_authority :
    <input type="text" size="60" id="input_update_authority" value="6EsaiJRWuNmHktqGemAaKEoFUd2kA864bcFgiysEEhMi" />
    <button onclick="find_nft_series()">Find NFT Series</button>
</p>

<hr>

<h1>NFTã®ã‚·ãƒªãƒ¼ã‚º</h1>
<p>è¦‹ã¤ã‹ã£ãŸã‚‚ã®ã‹ã‚‰æœ€åˆã®20å€‹ã ã‘è¡¨ç¤ºã—ã¾ã™...</p>

<p id="error" style="color: red;"></p>
<p id="msg"></p>

<ul id="nfts">
</ul>

</body>
</html>
